<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link href='https://fonts.googleapis.com/css?family=Open+Sans|Oswald' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="css/cuerpo.css">
	<link rel="stylesheet" type="text/css" href="css/menu.css">
	<link rel="stylesheet" type="text/css" href="css/formulario.css">
</head>
<body>
	<div contenedor>
		
	</div>
</body>
<script type="text/javascript" src='js/constructor.js'></script>
<script type="text/javascript" src='js/motorRegistros.js'></script>

<script type="text/javascript">


/*-----------------------------Inicialiazacion de formulario--------------------------------------------------*/

	//arranca el motor de registros que se comunica con BD
	var torque = new Motor('rol');
	
	//Inicialiazion de UI(Interfaz De Usuario)
	var UI = new Arquitecto();
	UI.configure();
	//se cargan los registros necesarios que no forman parte de la entidad activa pero
	//que de igual forma se utilizaran dentro del maestro
	var empresas = torque.buscarRegistros('empresa');
	
	//Se inicializa la botonera con sus respectivos botones
	var botones = ['buscar','nuevo','abrir'];
	UI.elementos.botonera = new Botonera(botones);

	//se inicializa el formulario
	UI.elementos.formulario = new Formulario(torque.entidadActiva);

/*-------------------------Fin Inicialiazacion de formulario--------------------------------------------------*/

	//funcionamiento exclusivo del formulario
	function guardar(){
		var formulario = document.formNuevo.elements;
		var data = new Array();
		var elemento;
		if((formulario.Nombre.value!='')&&(formulario.Descripcion.value!='')&&(formulario.Estado.value!='')){
			var nuevoRegistro = {
				nombre : formulario.Nombre.value,
				id : contId++,
				descripcion : formulario.Descripcion.value,
				estado: formulario.Estado.value,
				detalle : []
			}
			torque.guardar(nuevoRegistro,'rol');
			var nuevoSlot=UI.elementos.formulario.ventanaList.agregarSlot(nuevoRegistro);
			nuevoSlot.firstChild.click();
		}else{
			//creo el mensaje
			var mensaje='Por favor rellene todos los campos antes de continuar';
			var data={
				tipo:'error',
				cabecera:'Error',
				cuerpo:mensaje
			}
			UI.crearVentanaModal(data);
		}
	}
	//------------------------------------------Funciones Propias de la UI de este formulario---------------------------
		
		//declaro el objeto donde se encuentra la UI del formulario 
		var objForm=UI.elementos.formulario.ventanaForm;

		objForm.prototype.reconstruirUI=function(){
			var html='';
			var tiempo = (this.estado=='agregado')?600:0;
			if(this.tipo=='nuevo'){
				this.registroId='';
				UI.elementos.formulario.ventanaList.controlLista();
				this.nodo.style.height='0px';		
				setTimeout(function(){
					var nodo=UI.elementos.formulario.ventanaForm.nodo;
					nodo.style.height='450px';
					html+='\
					<section titulo>Nuevo Rol</section>\
						<section sector>\
							<form name ="formNuevo">\
								<div class="group">\
							      <input type="text" name="Nombre" required>\
							      <span class="highlight"></span>\
							      <span class="bar"></span>\
							      <label>Nombre</label>\
							    </div>\
							    <div class="group" area>\
							      <textarea name="Descripcion" required></textarea>\
							      <span class="highlight"></span>\
							      <span class="bar"></span>\
							      <label>Descripcion</label>\
							    </div>\
							    <div formElements>\
							    	<label class="radio"><input id="radio1" type="radio" name="Estado" ><span class="outer"><span class="inner"></span></span>Activo</label>\
							    	<label class="radio"><input id="radio2" type="radio" name="Estado" ><span class="outer"><span class="inner"></span></span>Inactivo</label>\
							    </div>\
							</form>\
						</section>\
					</section>';
					nodo.innerHTML=html;
					UI.elementos.formulario.ventanaForm.agregarFuncionamiento();
				},tiempo);
				UI.elementos.botonera.agregarBoton('guardar');
				UI.elementos.botonera.quitarBoton('eliminar');
			}else if(this.tipo='modificar'){
				var data = torque.buscarRegistro(this.registroId,torque.entidadActiva);
				UI.elementos.botonera.agregarBoton('eliminar');
				UI.elementos.botonera.quitarBoton('guardar');
				this.nodo.style.height='0px';		
				setTimeout(function(){
					var nodo=UI.elementos.formulario.ventanaForm.nodo;
					nodo.style.height='250px';
					nodo.style.borderRadius='0px';
						html+='\
					<section titulo><textarea  name="nombre"></textarea><span>'+data.nombre+'</span><article update="campo"></article></section>\
						<section sector>\
							<div><textarea name="descripcion"></textarea><span >'+data.descripcion+'</span><article update="area"></article></div>\
						</section>\
						<section sector>\
							<div>Empresas</div>\
							<section contenedor id="contenedorPri">\
							</section>\
						</section>\
					</section>';
					nodo.innerHTML=html;
					normalizarNodo(nodo);
					normalizarNodo(nodo.childNodes[2]);
					var contenedor=nodo.childNodes[2].childNodes[1];
					this.nodo=nodo;
					//arreglo temporal de empresas
						dataTemp=torque.buscarDetalle(data.id,'rol');
						UI.elementos.formulario.ventanaForm.agregarEmpresas(contenedor,dataTemp);
				},tiempo);
			}
		};
		objForm.prototype.agregarEmpresas=function(contenedor,elementos){
			var html="";
			for(var x=0;x<elementos.length;x++){
				html+="<article empresa>"+elementos[x].nombre+"</article>";
			}
			html+='<article add="empresa"></article>';
			contenedor.innerHTML=html;
			this.agregarFuncionamiento();
		};
		objForm.prototype.agregarEmpresa = function(empresa,contenedor){
			var nodo=document.createElement('article');
			nodo.textContent = empresa.nombre;
			nodo.setAttribute('empresa','');
			contenedor.insertBefore(nodo,contenedor.lastChild);
			this.agregarFuncionamiento();
		};
		objForm.prototype.agregarFuncionamiento = function(){
			var nodo=this.nodo;
			var lista=nodo.getElementsByTagName('article');
			for(var x=0;x<lista.length;x++){
				lista[x].style.cursor='pointer';
				if(lista[x].getAttribute('update')!==null){
					lista[x].onclick=this.edicion;
				}else if(lista[x].getAttribute('empresa')!==null){
					lista[x].onclick=function(){
						var registro = torque.buscarRegistro(UI.elementos.formulario.ventanaForm.registroId,torque.entidadActiva);
						//structura de la ventana modal
						var dataTemp = {
							cabecera:'Operaciones En '+this.textContent,
							cuerpo:'Las Operaciones disponibles son: <br>Eliminar Asociacion<br>Modificar Privilegios',
							pie:'<section modalButtons>\
									<button type="button" cancelar id="modalButtonCancelar"></button>\
									<button type="button" modificar ruta="'+registro.id+'" id="modalButtonModificar"></button>\
									<button type="button" eliminar  id="modalButtonEliminar"></button>\
								</section>'
						}
						
						//creo la ventana modal
						UI.crearVentanaModal(dataTemp);						

						//agrego funcionamiento a los botones de la ventaModal
						var btnCancelar = document.getElementById("modalButtonCancelar");
						var btnModificar= document.getElementById("modalButtonModificar");
						var btnEliminar = document.getElementById("modalButtonEliminar");

						btnCancelar.onclick= function(){
							UI.elementos.modalWindow.eliminarUltimaCapa();
						}
						btnEliminar.onclick=function(){
							var dataTemp = {
								tipo:'advertencia',
								cabecera:'Advertencia',
								cuerpo:'Si Elimina esta Asociacion se perderan todos los datos del Mismo<br><br>Â¿Realmente desea eliminarla?',
								pie:'<section modalButtons>\
										<button type="button" cancelar 	></button>\
										<button type="button" eliminar  ></button>\
									</section>'
							}
						
							//creo la ventana modal
							var capaContenido=UI.crearVentanaModal(dataTemp);
							var btnCancelar=capaContenido.nodo.getElementsByTagName('button')[0];
							btnCancelar.onclick=function(){
								UI.elementos.modalWindow.eliminarUltimaCapa();
							}
						}
						btnModificar.onclick= function(){
							location.href=this.getAttribute('enlace');
						}
					}
				}else if(lista[x].getAttribute('add')!==null){
					lista[x].onclick=function(){
						//busco el registro con la informacion que voy a utilizar
						var registro = torque.buscarRegistro(UI.elementos.formulario.ventanaForm.registroId,torque.entidadActiva);

						//armo la estructura de la ventana modal
						var dataTemp = {
							cabecera:'Asignar Empresa',
							cuerpo:'<label>'+registro.nombre+'</label><div clear></div>\
									<div formElements area>\
										<article capaSelect></article><select name="listaEmpresas" id="listaEmpresas">\
											<option value="-">Selecione un Valor</option>\
											<option value="1">SocaServicios</option>\
											<option value="2">SocaPortuguesa</option>\
											<option value="3">Probioagro</option>\
											<option value="4">E/S Piedritas Blancas</option>\
										</select>\
									</div>',
							pie:'<section modalButtons>\
									<button type="button" cancelar id="modalButtonCancelar"></button>\
									<button type="button" aceptar  id="modalButtonAceptar"></button>\
								</section>'
						}

						//creo la ventana modal
						UI.crearVentanaModal(dataTemp);
						
						UI.elementos.modalWindow.buscarUltimaCapaContenido().partes.cuerpo.nodo.style.height='200px';
						
						//armo la lista de valores no permitidos para el combo
						var empresas=torque.buscarDetalle(UI.elementos.formulario.ventanaForm.registroId,'rol');
						var valoresNoPermitidos= Array();
						for(var x=0;x<empresas.length;x++){
							valoresNoPermitidos.push(empresas[x].id);
						}
						//valido el combo box con los valores recopilados
						UI.elementos.formulario.validarCombo(valoresNoPermitidos,document.getElementById('listaEmpresas'));
						

						//agrego funcionamiento a los botones
						var btnCancelar = document.getElementById("modalButtonCancelar");
						var btnAceptar 	= document.getElementById("modalButtonAceptar");
						var comboEmpresas = UI.elementos.modalWindow.buscarUltimaCapaContenido().partes.cuerpo.nodo.getElementsByTagName('select')[0];

						comboEmpresas.previousSibling.onclick = function(){
							UI.elementos.formulario.construirCapaSelect(this);
						}

						btnCancelar.onclick=function(){
							UI.elementos.modalWindow.eliminarUltimaCapa();
						}

						btnAceptar.onclick=function(){
							var lista = document.getElementById('listaEmpresas');
							//guardo el empresa
							if(lista.value!='-'){
								if(lista.value!='cerrar'){
									var empresa= {	
										id: lista.value,
										nombre: lista.options[lista.selectedIndex].textContent
									}
									var cambios = Array();
									cambios.push(empresa);
									torque.guardarEnDetalle(UI.elementos.formulario.ventanaForm.registroId,cambios);
									
									UI.elementos.formulario.ventanaForm.agregarEmpresa(empresa,document.getElementById('contenedorPri'));
									//cierro capa
									UI.elementos.modalWindow.eliminarUltimaCapa();
								}else{
									UI.elementos.modalWindow.eliminarUltimaCapa();
								}
								
							}else{
								document.getElementById('listaEmpresas').options[document.getElementById('listaEmpresas').selectedIndex].textContent='Debe Elegir un Valor para Continuar';
							}
							
						}
					}
				}else if(lista[x].getAttribute('capaSelect')!==null){
					lista[x].onclick=function(){
						UI.elementos.formulario.construirCapaSelect(this);
					}
				}
			}
			lista = this.nodo.getElementsByTagName('input');
			for(var x=0; x<lista.length;x++){
				if((lista[x].type=='text')&&(lista[x].parentNode.nodeName.toLowerCase()=='div')){
					lista[x].parentNode.onmouseover=UI.elementos.formulario.abrirtooltipInput;
					lista[x].parentNode.onmouseout=UI.elementos.formulario.cerrartooltipInput;
				}
			}
			lista = this.nodo.getElementsByTagName('textarea');
			for(var x=0; x<lista.length;x++){
				if(lista[x].parentNode.classList.contains('group')){
					lista[x].parentNode.onmouseover=UI.elementos.formulario.abrirtooltipInput;
					lista[x].parentNode.onmouseout=UI.elementos.formulario.cerrartooltipInput;
				}
			}
		};
</script>
</html>