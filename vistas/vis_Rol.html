<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link href='https://fonts.googleapis.com/css?family=Open+Sans|Oswald' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="css/cuerpo.css">
	<link rel="stylesheet" type="text/css" href="css/menu.css">
	<link rel="stylesheet" type="text/css" href="css/formulario.css">
</head>
<body>
	<div contenedor>
		
	</div>
</body>
<script type="text/javascript" src='js/constructor.js'></script>
<script type="text/javascript" src='js/motorRegistros.js'></script>

<script type="text/javascript">


/*-----------------------------Inicialiazacion de formulario--------------------------------------------------*/
	//arranca la sesion
	var sesion = new Sesion();

	//arranca el motor de registros que se comunica con BD
	var torque = new Motor('rol');
	
	//Inicialiazion de UI(Interfaz De Usuario)
	var UI = new Arquitecto();
	UI.configure();
	//se cargan los registros necesarios que no forman parte de la entidad activa pero
	//que de igual forma se utilizaran dentro del maestro
	var empresas
	torque.Busqueda({entidad:'empresa',operacion:'buscar'},function(respuesta){
		empresas=respuesta.registros;
	});
	
	//Se inicializa la botonera con sus respectivos botones
	var botones = ['buscar','nuevo','abrir'];
	UI.elementos.botonera = new Botonera(botones);

	//se inicializa el formulario
	UI.elementos.formulario = new Formulario(torque.entidadActiva);

	sesion.obtenerSesion();

/*-------------------------Fin Inicialiazacion de formulario--------------------------------------------------*/

	//funcionamiento exclusivo del formulario
	function guardar(){
		var formulario = document.formNuevo;
		var data = new Array();
		var elemento;
		var validacion=false;
		for(var x=0;x<formulario.elements.length;x++){
			if((formulario.elements[x].type=='text')||(formulario.elements[x].type=='password')){
				if(formulario.elements[x].value==''){
					validacion=true;
				}
			}
			elemento = {nombre:formulario.elements[x].name,valor:formulario.elements[x].value};
			data.push(elemento);
		}
		if(!validacion){
			//guardo en base de datos
			torque.guardar(torque.entidadActiva,data,function(respuesta){
				var nuevoSlot=UI.elementos.formulario.ventanaList.agregarSlot(respuesta.registros);

				//cambio a modificacion
				nuevoSlot.firstChild.click();
			});
			
		}else{
			console.log('formulario no paso la validacion');
		}
	}
	//------------------------------------------Funciones Propias de la UI de este formulario---------------------------
		
		//declaro el objeto donde se encuentra la UI del formulario 
		var objForm=UI.elementos.formulario.ventanaForm;

		objForm.prototype.reconstruirUI=function(){
			var html='';
			var tiempo = (this.estado=='agregado')?600:0;
			if(this.tipo=='nuevo'){
				this.registroId='';
				UI.elementos.formulario.ventanaList.controlLista();
				this.nodo.style.height='0px';		
				setTimeout(function(){
					var capaForm=UI.elementos.formulario.ventanaForm;

					//inicializo valores basicos del formulario
					var titulo = 'Rol';
					var altura = 210;
					
					//construyo el html
					capaForm.crearEstructuraBasicaNuevo(titulo,altura);

					var campos = [
						{
							tipo : 'campoDeTexto',
							parametros : {titulo:'Nombre',nombre:'nombre',tipo:'simple',eslabon:'simple',usaToolTip:true}
						},{
							tipo : 'campoDeTexto',
							parametros : {titulo:'Descripcion',nombre:'descripcion',tipo:'area',eslabon:'area',usaToolTip:true}
						}
					]
					//agrego dichos campos
					UI.elementos.formulario.ventanaForm.agregarCampos(campos);
				},tiempo);

				//funcionamiento botones
				UI.elementos.botonera.agregarBoton('guardar');
				UI.elementos.botonera.quitarBoton('eliminar');

			}else if(this.tipo='modificar'){

				//funcinamiento botones
				UI.elementos.botonera.agregarBoton('eliminar');
				UI.elementos.botonera.quitarBoton('guardar');
				
				this.nodo.style.height='0px';
				
				//busco informacion del registro
				setTimeout(function(){
					var nodo=UI.elementos.formulario.ventanaForm.nodo;
					nodo.style.height='250px';
					nodo.style.borderRadius='0px';
					//------------Cuadro Carga-------------------------------
					var infoCuadro = {
						mensaje:'Buscando'
					}
					nodo.innerHTML='';
					var cuadroDeCarga=UI.crearCuadroDeCarga(infoCuadro,nodo);
					cuadroDeCarga.style.marginTop='80px';
					//--------------------------------------------------------
					var info={
						codigo:UI.elementos.formulario.ventanaForm.registroId,
						entidad:torque.entidadActiva,
						operacion:'buscarRegistro'
					}
					torque.Busqueda(info,function(respuesta){
						//guardo de forma local los datos para facil acceso
						var data = respuesta.registros;
						/*Actualizo en el objeto formulario la informacion recibida de manera que
						si en un futuro cercano necesito consultar no debo salir del cliente para lo mismo*/
						UI.elementos.formulario.ventanaForm.registroAct=data;

						var formulario = UI.elementos.formulario.ventanaForm;
						//inicializo los datos del titulo del formulario y la altura del mismo
						var titulo = {
							nombre:'Nombre',
							valor:data.nombre
						}
						var altura = 310;
						//monto la estructura basica sobre la cual se montan los campos a agregar
						formulario.crearEstructuraBasicaModificar(titulo,altura);
						//inicializo el arreglo con los campos a agregar
						var campos = [
							{
								tipo : 'campoEdicion',
								parametros : {titulo:'Descripcion',nombre:'descripcion',valor:data.descripcion,tipo:'area'}
							}
						]
						//agrego los campos
						formulario.agregarCampos(campos);
						//sector inferior
						let empresas = formulario.agregarSector({
							html:'<div>Empresas</div><section contenedor id="contenedorPri"></section>',
							division:false
						})
						var contenedor = empresas.querySelector('section[contenedor]')
						//arreglo temporal de empresas
							UI.elementos.formulario.ventanaForm.agregarEmpresas(contenedor,data.detalle);
						
					});
				},tiempo);
			}
		};
		objForm.prototype.agregarEmpresas=function(contenedor,elementos){
			var html="";
			html+='<article add="empresa"></article>';
			for(var x=0;x<elementos.length;x++){
				html+="<article empresa='"+elementos[x].codigo+"' codigo='"+elementos[x].codigoRelacion+"'>"+elementos[x].nombre+"</article>";
			}
			contenedor.innerHTML=html;
			this.agregarFuncionamiento();
		};
		objForm.prototype.agregarEmpresa = function(empresa,contenedor){
			var nodo=document.createElement('article');
			nodo.textContent = empresa.nombre;
			nodo.setAttribute('empresa',empresa.codigo);
			contenedor.appendChild(nodo);
			this.agregarFuncionamiento();
		};
		objForm.prototype.eliminarEmpresa = function(empresa,contenedor){
			var empresas=this.registroAct.detalle;
			for(var x=0;x<empresas.length;x++){
				if(empresas[x].codigo==empresa.codigo){
					var indice=x;
				}
			}
			empresas.splice(indice,1);
			var lista = contenedor.childNodes;
			for(var x=0;x<lista.length;x++){
				if(lista[x].nodeName.toLowerCase()=='article'){
					if(lista[x].getAttribute('empresa')==empresa.codigo){
						contenedor.removeChild(lista[x]);
					}
				}
			}
		};
		objForm.prototype.agregarFuncionamiento = function(){
			var nodo=this.nodo;
			var lista=nodo.getElementsByTagName('article');
			for(var x=0;x<lista.length;x++){
				lista[x].style.cursor='pointer';
				if(lista[x].getAttribute('update')!==null){
					lista[x].onclick=this.edicion;
				}else if(lista[x].getAttribute('empresa')!==null){
					lista[x].onclick=function(){
						//structura de la ventana modal
						var dataTemp = {
							cabecera:'Operaciones En '+this.textContent,
							cuerpo:'Las Operaciones disponibles son: <br>Eliminar Asociacion<br>Modificar Privilegios',
							pie:'<section modalButtons>\
									<button type="button" cancelar id="modalButtonCancelar"></button>\
									<button type="button" modificar ruta="'+this.getAttribute('codigo')+'" id="modalButtonModificar"></button>\
									<button type="button" eliminar codigo="'+this.getAttribute('empresa')+'"  id="modalButtonEliminar"></button>\
								</section>'
						}
						
						//creo la ventana modal
						UI.crearVentanaModal(dataTemp);						

						//agrego funcionamiento a los botones de la ventaModal
						var btnCancelar = document.getElementById("modalButtonCancelar");
						var btnModificar= document.getElementById("modalButtonModificar");
						var btnEliminar = document.getElementById("modalButtonEliminar");

						btnCancelar.onclick= function(){
							UI.elementos.modalWindow.eliminarUltimaCapa();
						}
						btnEliminar.onclick=function(){
							var dataTemp = {
								tipo:'advertencia',
								cabecera:'Advertencia',
								cuerpo:'Si Elimina esta Asociacion se perderan todos los datos del Mismo<br><br>Â¿Realmente desea eliminarla?',
								pie:'<section modalButtons>\
										<button type="button" cancelar 	></button>\
										<button type="button" eliminar codigo="'+this.getAttribute('codigo')+'" ></button>\
									</section>'
							}
						
							//creo la ventana modal
							var capaContenido=UI.crearVentanaModal(dataTemp);
							var btnCancelar=capaContenido.nodo.getElementsByTagName('button')[0];
							var btnEliminar=capaContenido.nodo.getElementsByTagName('button')[1];
							btnCancelar.onclick=function(){
								UI.elementos.modalWindow.eliminarUltimaCapa();
							}
							btnEliminar.onclick=function(){
								
								//------------Cuadro Carga-------------------------------
								var contenedor = UI.elementos.modalWindow.buscarUltimaCapaContenido().partes.cuerpo.nodo;
								var infoCuadro={
									tipo:'advertencia',
									mensaje:'Eliminando Registro'
								}
								capaContenido.partes.cuerpo.nodo.innerHTML='';
								var cuadroDeCarga=UI.crearCuadroDeCarga(infoCuadro,contenedor);
								cuadroDeCarga.style.width='150px';
								//--------------------------------------------------------

								var peticion={
									operacion:'eliminarDetalle',
									cod_emp:this.getAttribute('codigo'),
									codigo:UI.elementos.formulario.ventanaForm.registroId,
									entidad:'rol'
								}
								//ejecuto operacion
								torque.Operacion(peticion,function(respuesta){

									var cuadroDeCarga=UI.elementos.cuadroCarga;
									//culmino carga
									cuadroCarga.culminarCarga(respuesta,function(respuesta){
										var empresa={
											codigo:respuesta.cod_emp
										}
										UI.elementos.formulario.ventanaForm.eliminarEmpresa(empresa,document.getElementById('contenedorPri'));
										UI.elementos.modalWindow.eliminarUltimaCapa();
										setTimeout(function(){UI.elementos.modalWindow.eliminarUltimaCapa();},820);
									});
								});
							}
						}
						btnModificar.onclick= function(){
							location.href=this.getAttribute('enlace');
						}
					}
				}else if(lista[x].getAttribute('add')!==null){
					lista[x].onclick=function(){
						//busco el registro con la informacion que voy a utilizar
						var registro = UI.elementos.formulario.ventanaForm.registroAct;

						//armo la estructura de la ventana modal
						var dataTemp = {
							cabecera:'Asignar Empresa',
							cuerpo:'<label>'+registro.nombre+'</label>',
							pie:'<section modalButtons>\
									<button type="button" cancelar id="modalButtonCancelar"></button>\
									<button type="button" aceptar  id="modalButtonAceptar"></button>\
								</section>'
						}

						//creo la ventana modal
						UI.crearVentanaModal(dataTemp);
						var capaEnUso=UI.elementos.modalWindow.buscarUltimaCapaContenido();
						capaEnUso.partes.cuerpo.nodo.style.height='250px';
						
						//agrego funcionamiento a los botones
						var btnCancelar = document.getElementById("modalButtonCancelar");
						var btnAceptar 	= document.getElementById("modalButtonAceptar");
						btnCancelar.onclick=function(){
							UI.elementos.modalWindow.eliminarUltimaCapa();
						}

						btnAceptar.onclick=function(){
							var lista = document.getElementById('listaEmpresas');
							//guardo el empresa
							if(lista.value!='-'){
								if(lista.value!='cerrar'){
									var peticion= {	
										cod_emp: lista.value,
										codigo: UI.elementos.formulario.ventanaForm.registroId,
										entidad: 'rol',
										Operacion:'guardarDetalle'
									}
									torque.Operacion(peticion,function(respuesta){
										if(respuesta.success===1){
											//actualizo el detalle del registro activo
											UI.elementos.formulario.ventanaForm.registroAct.detalle.push(respuesta.registro);											
											var empresa={
												codigo:lista.value,
												nombre:lista.options[lista.selectedIndex].textContent
											}
											
											UI.elementos.formulario.ventanaForm.agregarEmpresa(empresa,document.getElementById('contenedorPri'));
										}
										//cierro capa
										UI.elementos.modalWindow.eliminarUltimaCapa();
									});
								}else{
									UI.elementos.modalWindow.eliminarUltimaCapa();
								}
								
							}else{
								document.getElementById('listaEmpresas').options[document.getElementById('listaEmpresas').selectedIndex].textContent='Debe Elegir un Valor para Continuar';
							}
							
						}
						//---------------------------------------fin funcionamiento botones ------------------------------------------------------
						//------------Cuadro Carga---------------------------------------------------------
						var infoCuadro = {
							mensaje:'Cargando'
						}
						var cuadroDeCarga=UI.crearCuadroDeCarga(infoCuadro,capaEnUso.partes.cuerpo.nodo);
						cuadroDeCarga.style.marginTop='80px';
						//-----------------------------------------------------------------------------------
						
						torque.buscarRegistros('empresa',function(respuesta){
							//--------------------------creo el combo-----------------
							var comboData={
								titulo:'Empresa',
								nombre:'empresas',
								eslabon:'area',
								id:'listaEmpresas',
								opciones:respuesta.registros
							}
							var comboBox = new ComboBox(comboData);
							//--------------------------------------------------------
							
							var capaEnUso=UI.elementos.modalWindow.buscarUltimaCapaContenido();
							capaEnUso.partes.cuerpo.nodo.innerHTML='<label>'+registro.nombre+'</label><div clear></div>';
							capaEnUso.partes.cuerpo.nodo.appendChild(comboBox.nodo);

							//armo la lista de valores no permitidos para el combo
							var empresas=UI.elementos.formulario.ventanaForm.registroAct.detalle;
							var valoresNoPermitidos= Array();
							for(var x=0;x<empresas.length;x++){
								valoresNoPermitidos.push(empresas[x].codigo);
							}
							//valido el combo box con los valores recopilados
							UI.elementos.formulario.validarCombo(valoresNoPermitidos,document.getElementById('listaEmpresas'));
						});
						
					}
				}else if(lista[x].getAttribute('capaSelect')!==null){
					lista[x].onclick=function(){
						construirCapaSelect(this);
					}
				}
			}
			lista = this.nodo.getElementsByTagName('input');
			for(var x=0; x<lista.length;x++){
				if((lista[x].type=='text')&&(lista[x].parentNode.nodeName.toLowerCase()=='div')){
					lista[x].parentNode.onmouseover=UI.elementos.formulario.abrirtooltipInput;
					lista[x].parentNode.onmouseout=UI.elementos.formulario.cerrartooltipInput;
				}
			}
			lista = this.nodo.getElementsByTagName('textarea');
			for(var x=0; x<lista.length;x++){
				if(lista[x].parentNode.classList.contains('group')){
					lista[x].parentNode.onmouseover=UI.elementos.formulario.abrirtooltipInput;
					lista[x].parentNode.onmouseout=UI.elementos.formulario.cerrartooltipInput;
				}
			}
		};
</script>
</html>